<!DOCTYPE html>
<html lang="en">
<head>
<title>GcodeNinja</title>
<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: -50%;
        bottom: 0;
        left: 50%;
    }
    .myMarker {
  position:absolute;
  background:rgba(100,200,100,0.5);
  z-index:20

}

    * { margin: 10; padding: 0;}

    body, html { height:99%;  width:99%; }

</style>
</head>
<body>
<!-- <div style="display: flex;"> -->
    <div style="width:50%;height:70%" id="editor">G0 F10000
G0 X0 Y0 F10000
G0 Z6
M3 M7
G1 X20 F1000 S0.6
M5 M9
G0 X24
M3 M7
G1 Y20
M5 M9
G0 X29 Y-0
G0 Z7
M3 M7
G1 Y20
M5 M9
G0 X34 Y0
G0 Z8
M3 M7
G1 Y20
M5 M9
G0 X39 Y-0
G0 Z9
M3 M7
G1 Y20
M5 M9
G0 X44 Y-0
G0 Z10
M3 M7
G1 Y20
M5 M9
G0 X0
M3 M7
G1 X20
M5 M9
G0 X0 Y15
G0 Z9
M3 M7
G1 X20
M5 M9
G0 X0 Y10
G0 Z8
M3 M7
G1 X20
M5 M9
G0 X0 Y5
G0 Z7
M3 M7
G1 X20
M5 M9
G0 X47 Y22
G0 Z8
M3 M7
G1 X-3 F300
G1 Y-1.75
G1 X-1.3333 Y-3
G1 X47
G1 Y22
M5 M9
G0 X0 Y0
M2</div>

<!-- </div> -->

<div style="width:50%;height:70%">
    <svg id='svgy' width='98%' height='100%'>
    </svg>
    <input value='0.9' id='maxPowerInput' ><button onclick="setMaxPowahPressed()">Set max powah</button>Scales all S params relatively to the maximum power in the program.<br><br>
    <button onclick="downloadPRessed()">Download GCode</button><br>
    <button onclick="refreshsvg()">Refresh SVG View</button><br>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.13.2/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/gcode");

    // var Range = ace.require('ace/range').Range;
    // editor.session.addMarker(new Range(22, 0, 23, 1), "myMarker", "fullLine");
    editor.resize()
editor.getSession().on('change', function() {
  refreshsvg();
})

function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}

function downloadPRessed()
{
 download("file.gcode",  editor.getValue()) ;
}

function getMaxPOwerFromGcode() {
 
  var maxPowah = 0 ; 
  var textData = editor.getValue().split('\n'); 
  console.log(textData) ;

  for (var i = 0; i < textData.length; i++) {
    let position = textData[i].search("S");
    if(position >  -1 )
    {
        console.log(position); 
        console.log(textData[i]) ;
        var tempstr = textData[i].substring( position + 1 ) // +1 to exclude the S automatically
        console.log(tempstr) ;
        if(tempstr.search(" ") > 0 ) // remove extra gcodes after S param
        {
            tempstr = tempstr.substring(0 , tempstr.search(" "))
            console.log(tempstr);
        }
        if(maxPowah < tempstr)
        {
            maxPowah = tempstr
            
        }

    }
  } 
  return maxPowah  
}
function displayMaxPowah()
{
    // document.getElementById('maxPowerInput').value = getMaxPOwerFromGcode();
}

function setMaxPowahPressed()
{
    setMaxPowah(document.getElementById('maxPowerInput').value)
}

function generateSVG()
{

    var textData = editor.getValue() ; 
    // console.log(textData)
    var commandList = []
    var prevChar = '\n'
    var prevSpace = 0 
    var prevSpace2 = 0 

    for (var i = 0; i < textData.length; i++) 
    {

        var Char = textData[i] 

        if((Char == 'M' || Char == 'G') && (prevChar==' ' ||prevChar=='\n') )
        {
            // console.log(textData.substr(prevSpace2   , prevSpace - prevSpace2))
            var Raw = textData.substr(prevSpace2   , prevSpace - prevSpace2)
            var Split = Raw.substr(0,Raw.length -1).split(' ')
            commandList.push( { Raw:Raw , Split:Split } )
            prevSpace2 = prevSpace 
            prevSpace = i 
        }

        prevChar = textData[i]
    }
    // console.log(commandList);

    var LastPos = {x:0, y:0 , z:0}
    var NewPos = {x:0, y:0 , z:0}
    for (var i = 0; i < commandList.length; i++) {
        if( commandList[i].Split[0] == 'G0' || commandList[i].Split[0] == 'G1'  )
        {
            for (var j = 1; j < commandList[i].Split.length; j++) 
            {
                // console.log(commandList[i].Split[j].substring(1,commandList[i].Split[j].length ))
                if(commandList[i].Split[j][0] == 'X' )
                {
                    NewPos.x =   commandList[i].Split[j].substring(1,commandList[i].Split[j].length )
                }
                if(commandList[i].Split[j][0] == 'Y' )
                {
                    NewPos.y =   commandList[i].Split[j].substring(1,commandList[i].Split[j].length )
                }
                if(commandList[i].Split[j][0] == 'Z' )
                {
                    NewPos.z =   commandList[i].Split[j].substring(1,commandList[i].Split[j].length )
                }

                // svgy.insertAdjacentHTML('beforeend' , `<circle cx='${LastPos.x * 5 +50   }' cy='${LastPos.y* 5 + 50 }' r='2' stroke='blue' stroke-width='3' fill='red' />`) ; 
                // console.log('adding lines?')
                
            }
                var linesvg = `<line x1="${LastPos.x * 5 + 50}" y1="${LastPos.y * 5 + 50}" x2="${NewPos.x * 5 + 50}" y2="${NewPos.y * 5 + 50}" style="stroke:rgb(128,0,0);stroke-width:2" />`
                console.log(linesvg)
                var svgy = document.getElementById('svgy')
                svgy.insertAdjacentHTML('beforeend' ,linesvg) ; 

                console.log(LastPos)
                console.log(NewPos)
                LastPos.x = NewPos.x
                LastPos.y = NewPos.y
                LastPos.z = NewPos.z
                // LastPos = NewPos;
            
        }
        if( commandList[i].Split[0] == 'M5' || commandList[i].Split[0] == 'M3' || commandList[i].Split[0] == 'M7'  || commandList[i].Split[0] == 'M9' )
        {
            var svgy = document.getElementById('svgy')
            // svgy.insertAdjacentHTML('beforeend' , '<rect x="10" y="10" rx="15" ry="15" width=99% height=99% style="fill:#20208002;stroke:#70707000;stroke-width:0.5;opacity:1" />'
            svgy.insertAdjacentHTML('beforeend' , `<circle cx='${LastPos.x * 5 +50   }' cy='${LastPos.y* 5 + 50 }' r='2' stroke='blue' stroke-width='3' fill='red' />`) ; 
        }
    }
    // for (var i = 0; i < textData.length; i++) 
    // {
    //     var textString = textData[i] ; 

    //     for (var j = 0; j < textString.length; j++) {
    //         console.log(textString.charAt(j));
    //         // textString[i]
    //     }
    // }

}

function setMaxPowah(newMaxPowah)
{

    var currentMaxPowah = getMaxPOwerFromGcode();
    var factor = newMaxPowah/currentMaxPowah
    console.log(factor)

    var textData = editor.getValue().split('\n'); 
    console.log(textData) ;
    var output = []; 

      for (var i = 0; i < textData.length; i++) {
        let position = textData[i].search("S");
        if(position >  -1 )
        {
            console.log(position); 
            console.log(textData[i]) ;
            var tempstr = textData[i].substring( position + 1 ) // +1 to exclude the S automatically
            var tailStr = ""
            console.log(tempstr) ;
            if(tempstr.search(" ") > 0 ) // remove extra gcodes after S param
            {
                tailStr =  tempstr.substring(tempstr.search(" ")) ;
                tempstr = tempstr.substring(0 , tempstr.search(" "))
                console.log(tempstr);
            }
            var newPowah = Math.round(100 * (factor * tempstr)) / 100  ;
            console.log(newPowah)

            output.push(textData[i].substring( 0 , position + 1 ) + newPowah + tailStr)

        }
        else
        {
            output.push(textData[i])
        }
      } 
      editor.setValue(output.join("\n"))
      console.log(output) ; 
  // return maxPowah  
}
displayMaxPowah();

    var svgy = document.getElementById('svgy')
    svgy.insertAdjacentHTML('beforeend' , '<rect x="10" y="10" rx="15" ry="15" width=99% height=99% style="fill:#2020F010;stroke:#70707000;stroke-width:0.5;opacity:1" />')

generateSVG() ; 


function refreshsvg()
{
    var svgy = document.getElementById('svgy')
    svgy.innerHTML = '' ; 
    svgy.insertAdjacentHTML('beforeend' , '<rect x="10" y="10" rx="15" ry="15" width=99% height=99% style="fill:#2020F010;stroke:#70707000;stroke-width:0.5;opacity:1" />')    
    generateSVG() ; 

}


</script>
</body>
</html>